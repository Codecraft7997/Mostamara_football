<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>التوقعات</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      text-align: center;
      padding: 30px;
      color: white;
      margin: 0;
    }
    h1, h2 {
      color: white;
    }
    button {
      background-color: #1e90ff;
      color: white;
      padding: 15px 30px;
      margin: 20px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      border-radius: 8px;
    }
    button:hover {
      background-color: #0f75d3;
    }
    .page {
      display: none;
      margin-top: 30px;
    }
    .match {
      background-color: #333;
      border-radius: 15px;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      margin: 20px auto;
      cursor: pointer;
      border: 1px solid #555;
    }
    input {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
      background-color: #333333;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
    }
    .countdown, .timestamp {
      color: #1e90ff;
      font-size: 16px;
    }
    .disabled-message {
      color: red;
      font-weight: bold;
    }
    .prediction {
      font-size: 18px;
      padding: 8px;
      border-bottom: 1px solid #444;
    }
  </style>
</head>
<body>

<div id="homePage" class="page" style="display: block;">
  <h1>التوقعات</h1>
  <button onclick="showPage('semisPage')">الأدوار النهائية</button>
  <button onclick="showPage('finalPage')">النهائي</button>
</div>

<div id="semisPage" class="page">
  <h2>الأدوار النهائية</h2>
  <div class="match" onclick="showPage('match1Page')">العشري × محمود سعد (العودة)</div>
  <div class="match" onclick="showPage('match2Page')">السلسول × العربي (العودة)</div>
  <button onclick="showPage('homePage')">⬅ العودة</button>
</div>

<div id="finalPage" class="page">
  <h2>النهائي</h2>
  <div class="match" onclick="showPage('finalMatchPage')">المستعمرة × السلسول</div>
  <button onclick="showPage('homePage')">⬅ العودة</button>
</div>

<!-- صفحات التوقعات -->
<div id="match1Page" class="page">
  <h2>توقع المباراة: العشري × محمود سعد (العودة)</h2>
  <div id="countdown1" class="countdown"></div>
  <div id="timeMessage1" class="disabled-message"></div>
  <input type="text" id="nameInput1" placeholder="اسمك"><br>
  <input type="text" id="predictionInput1" placeholder="اكتب توقعك..."><br>
  <button id="submitBtn1" onclick="submitPrediction(1)">إرسال التوقع</button>
  <button onclick="showPredictions(1)">عرض التوقعات</button>
  <button onclick="showPage('semisPage')">⬅ العودة</button>
  <div id="predictionsPage1" class="page">
    <h3>التوقعات</h3>
    <div id="predictionsContainer1"></div>
    <button onclick="hidePredictions(1)">⬅ العودة</button>
  </div>
</div>

<div id="match2Page" class="page">
  <h2>توقع المباراة: السلسول × العربي (العودة)</h2>
  <div id="countdown2" class="countdown"></div>
  <div id="timeMessage2" class="disabled-message"></div>
  <input type="text" id="nameInput2" placeholder="اسمك"><br>
  <input type="text" id="predictionInput2" placeholder="اكتب توقعك..."><br>
  <button id="submitBtn2" onclick="submitPrediction(2)">إرسال التوقع</button>
  <button onclick="showPredictions(2)">عرض التوقعات</button>
  <button onclick="showPage('semisPage')">⬅ العودة</button>
  <div id="predictionsPage2" class="page">
    <h3>التوقعات</h3>
    <div id="predictionsContainer2"></div>
    <button onclick="hidePredictions(2)">⬅ العودة</button>
  </div>
</div>

<div id="finalMatchPage" class="page">
  <h2>توقع النهائي: المستعمرة × السلسول</h2>
  <div id="countdown3" class="countdown"></div>
  <div id="timeMessage3" class="disabled-message"></div>
  <input type="text" id="nameInput3" placeholder="اسمك"><br>
  <input type="text" id="predictionInput3" placeholder="اكتب توقعك..."><br>
  <button id="submitBtn3" onclick="submitPrediction(3)">إرسال التوقع</button>
  <button onclick="showPredictions(3)">عرض التوقعات</button>
  <button onclick="showPage('finalPage')">⬅ العودة</button>
  <div id="predictionsPage3" class="page">
    <h3>التوقعات</h3>
    <div id="predictionsContainer3"></div>
    <button onclick="hidePredictions(3)">⬅ العودة</button>
  </div>
</div>

<script>
  const deadlines = {
    1: new Date("2025-09-15T20:00:00"),
    2: new Date("2025-09-16T20:00:00"),
    3: new Date("2025-09-19T20:00:00"),
  };

  let predictions1 = [], predictions2 = [], predictions3 = [];

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    const target = document.getElementById(id);
    if (target) target.style.display = 'block';
  }

  function formatTimestamp(date) {
    return date.toLocaleString("ar-EG");
  }

  function isDeadlinePassed(matchNumber) {
    return new Date() >= deadlines[matchNumber];
  }

  async function sendToGoogle(matchNumber, name, prediction, time) {
    const url = "https://script.google.com/macros/s/AKfycbyCe6c5e7_1TBh7cvZrzdIrs8pZ_leWr-XDmSAFtRnRb1z6dxb6X04P3Jl0l7TIGTU/exec";
    const data = { match: matchNumber, name, prediction, time };
    try {
      await fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      return true;
    } catch (err) {
      console.error("خطأ في الإرسال:", err);
      return false;
    }
  }

  async function submitPrediction(matchNumber) {
    if (isDeadlinePassed(matchNumber)) {
      alert("انتهى وقت التوقعات!");
      return;
    }

    const name = document.getElementById(`nameInput${matchNumber}`).value.trim();
    const prediction = document.getElementById(`predictionInput${matchNumber}`).value.trim();

    if (!name || !prediction) {
      alert("من فضلك اكتب اسمك وتوقعك.");
      return;
    }

    const time = formatTimestamp(new Date());
    const success = await sendToGoogle(matchNumber, name, prediction, time);

    if (!success) {
      alert("❌ لم يتم إرسال التوقع. حاول مرة أخرى.");
      return;
    }

    alert("✅ تم إرسال التوقع.");
    document.getElementById(`nameInput${matchNumber}`).value = "";
    document.getElementById(`predictionInput${matchNumber}`).value = "";
  }

  async function getPredictionsFromGoogle(matchNumber) {
    const url = `https://script.google.com/macros/s/AKfycbyCe6c5e7_1TBh7cvZrzdIrs8pZ_leWr-XDmSAFtRnRb1z6dxb6X04P3Jl0l7TIGTU/exec?match=${matchNumber}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      return data;
    } catch (err) {
      console.error("خطأ في جلب التوقعات:", err);
      return [];
    }
  }

  async function showPredictions(matchNumber) {
    document.getElementById(`predictionsPage${matchNumber}`).style.display = "block";
    const container = document.getElementById(`predictionsContainer${matchNumber}`);
    container.innerHTML = "<p>جاري تحميل التوقعات...</p>";

    const data = await getPredictionsFromGoogle(matchNumber);
    container.innerHTML = "";

    if (!data.length) {
      container.innerHTML = "<p>لا توجد توقعات بعد.</p>";
      return;
    }

    data.forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "prediction";
      div.innerHTML = `<strong>${i + 1}. ${p.name}: ${p.prediction}</strong><br><span class="timestamp">(${p.time})</span>`;
      container.appendChild(div);
    });
  }

  function hidePredictions(matchNumber) {
    document.getElementById(`predictionsPage${matchNumber}`).style.display = "none";
  }

  function disableInputs(matchNumber) {
    document.getElementById(`nameInput${matchNumber}`).disabled = true;
    document.getElementById(`predictionInput${matchNumber}`).disabled = true;
    document.getElementById(`submitBtn${matchNumber}`).disabled = true;
  }

  function updateCountdown(matchNumber) {
    const countdown = document.getElementById(`countdown${matchNumber}`);
    const message = document.getElementById(`timeMessage${matchNumber}`);
    const now = new Date();
    const timeLeft = deadlines[matchNumber] - now;

    if (timeLeft <= 0) {
      countdown.textContent = "";
      message.textContent = "⚠ انتهى وقت التوقعات!";
      disableInputs(matchNumber);
      return;
    }

    const h = Math.floor(timeLeft / (1000 * 60 * 60));
    const m = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((timeLeft % (1000 * 60)) / 1000);
    countdown.textContent = `الوقت المتبقي: ${h} ساعة و ${m} دقيقة و ${s} ثانية`;
  }

  window.onload = function () {
    [1, 2, 3].forEach(num => {
      updateCountdown(num);
      setInterval(() => updateCountdown(num), 1000);
    });
  };
</script>
</body>
  </html>
